[ { "title": "Create Instana Golang intrument for Httptreemux", "url": "/posts/instana-httptreemux/", "categories": "Go, Instana", "tags": "golang, instana, httptreemux, instrument", "date": "2023-07-12 16:00:30 -0700", "snippet": "Instrumentation to httptreemuxpackage instahttptreemuximport (\t\"net/http\"\tmux \"github.com/dimfeld/httptreemux/v5\"\tinstana \"github.com/instana/go-sensor\")// NewRouter is wrapper for mux.NewRouter()f...", "content": "Instrumentation to httptreemuxpackage instahttptreemuximport (\t\"net/http\"\tmux \"github.com/dimfeld/httptreemux/v5\"\tinstana \"github.com/instana/go-sensor\")// NewRouter is wrapper for mux.NewRouter()func NewRouter(sensor instana.TracerLogger) *mux.TreeMux {\tr := mux.New()\tAddMiddleware(sensor, r)\treturn r}// AddMiddleware instruments the mux.Router instance with Instanafunc AddMiddleware(sensor instana.TracerLogger, router *mux.TreeMux) {\trouter.UseHandler(func(next http.Handler) http.Handler {\t\treturn http.HandlerFunc(func(w http.ResponseWriter, req *http.Request) {\t\t\tinstana.TracingNamedHandlerFunc(sensor, req.RequestURI, req.URL.Path, func(w http.ResponseWriter, req *http.Request) {\t\t\t\tnext.ServeHTTP(w, req)\t\t\t})(w, req)\t\t})\t})}References Quick start guide for enabling Golang apps to use Instana Gather process metrics only go get github.com/instana/go-sensor adding the following code at the beginning of your main() function: instana.InitSensor(instana.DefaultOptions()) Instrument your application Instrument HTTP service sensor := instana.NewSensor(\"my-http-server\")http.HandleFunc(\"/\", instana.TracingHandlerFunc(sensor, \"/\", func(w http.ResponseWriter, req *http.Request) { // ...})) req, err := http.NewRequest(\"GET\", url, nil)client := &amp;http.Client{ Transport: instana.RoundTripper(sensor, nil),}ctx := instana.ContextWithSpan(context.Background(), parentSpan)resp, err := client.Do(req.WithContext(ctx)) Instrumentation modules for 3rd-party frameworks Instana Git" }, { "title": "Modify default Instana Agent Docker image to include Zscaler cert", "url": "/posts/instana-zscaler/", "categories": "Docker, APM", "tags": "docker, zscaler, cert, jvm, instana agent", "date": "2023-07-12 10:47:30 -0700", "snippet": "Custom Docker Image of Instana Agent with Zscaler CertReasoningWhenever running Instana agent Docker containers behind Zscaler proxy, I got the following errors in Docker logs:\"instana agent bootst...", "content": "Custom Docker Image of Instana Agent with Zscaler CertReasoningWhenever running Instana agent Docker containers behind Zscaler proxy, I got the following errors in Docker logs:\"instana agent bootstrapping failed\"\"instana: ERROR: Cannot connect to the agent through default gateway. Scheduling retry\"In order to solve the problem, I created a custom image built on top of the Instana agent image. Basically, I add the Zscaler certificate to JVM trust store and run the agent with the customized image(tagged as “agent-zs” below).Instana Agent base image Pull the latest imagedocker pull icr.io/instana/agent Run a containerdocker run --name agent icr.io/instana/agent Login to the container using bashdocker exec -it agent bashJVM TrustStore Make a copy of the current trust store cacertscp /opt/instana/agent/jvm/jre/lib/security/cacerts ./trust-proxy.jks Add Zscaler cert to the trust store bundle/opt/instana/agent/jvm/jre/bin/keytool -importcert -file zscaler.crt \\ -alias zscaler -keystore ./trust-proxy.jks -storepass changeit Set a new password to the trust store if needed/opt/instana/agent/jvm/jre/bin/keytool.exe -storepasswd -new &lt;Your New Password&gt; \\ -keystore ./trust-proxy.jks -storepass changeit Replace the system trust store with the modified bundlecp ./trust-proxy.jks /opt/instana/agent/jvm/jre/lib/security/cacertsCreate a new Docker image with the modification above Save the container as an imagedocker commit agent Tag the imagedocker images -adocker tag f4f835cc9de0 agent-zsReferences How to Import Public Certificates into Java’s Truststore from a Browser Instana Self-signed certificates How to Create a Docker Image From a Container Examples using docker-compose with Instana agent: Instana Node.js SDK Demo: image URI is obsolete, see the next demo for current one. version: '3'services: agent: image: instana/agent:latest pid: \"host\" privileged: true volumes: - /var/run/docker.sock:/var/run/docker.sock - /dev:/dev - /sys:/sys - /var/log:/var/log networks: demomesh: aliases: - instana-agent environment: - INSTANA_AGENT_ENDPOINT=${agent_endpoint:?No agent endpoint provided} - INSTANA_AGENT_ENDPOINT_PORT=${agent_endpoint_port:-443} - INSTANA_AGENT_KEY=${agent_key:?No agent key provided} - INSTANA_DOWNLOAD_KEY=${download_key:-} - INSTANA_AGENT_ZONE=${agent_zone:-sdk-demo} expose: - 42699 receiver-app: build: context: ./receiver-app networks: demomesh: aliases: - receiver-app environment: - INSTANA_AGENT_HOST=agent - BIND_ADDRESS=0.0.0.0 expose: - 3216 ports: - 3216:3216 depends_on: - agent sender-app: build: context: ./sender-app networks: demomesh: aliases: - sender-app environment: - DOWNSTREAM_HOST=receiver-app depends_on: - receiver-appnetworks: demomesh: {} Instana Envoy Tracing Demo version: '3'services: client-app: build: context: ./client-app networks: - envoymesh environment: - INSTANA_DEV=1 - target_url=http://envoy-gateway:8000/envoy-demo envoy: build: context: ./envoy args: agent_key: ${agent_key} download_key: ${download_key} volumes: - ./envoy/envoy-gateway.yaml:/etc/envoy-gateway.yaml networks: envoymesh: aliases: - envoy-gateway environment: - INSTANA_DEV=1 - INSTANA_AGENT_HOST=instana-agent - INSTANA_AGENT_PORT=42699 ports: - \"8000:8000\" - \"8001:8001\" server-app: build: context: ./server-app args: agent_key: ${agent_key} download_key: ${download_key} networks: envoymesh: aliases: - server-app environment: - INSTANA_DEV=1 - INSTANA_AGENT_HOST=instana-agent - INSTANA_AGENT_PORT=42699 - SERVER_PORT=8080 expose: - \"8080\" agent: image: icr.io/instana/agent pid: \"host\" privileged: true volumes: - /var/run:/var/run - /run:/run - /dev:/dev:ro - /sys:/sys:ro - /var/log:/var/log:ro networks: envoymesh: aliases: - instana-agent environment: - INSTANA_AGENT_ENDPOINT=${agent_endpoint:-ingress-red-saas.instana.io} - INSTANA_AGENT_ENDPOINT_PORT=${agent_endpoint_port:-443} - INSTANA_AGENT_KEY=${agent_key} - INSTANA_DOWNLOAD_KEY=${download_key} - INSTANA_AGENT_ZONE=${agent_zone:-envoy-tracing-demo} expose: - \"42699\"networks: envoymesh: {} Install CA certificates on Linux systemsThe following is for Redhat, which Instana Agent Docker image is based on: Create the /etc/pki/ca-trust/source/anchors directory if not yet present, Copy the .crt files into the directory, Run “update-ca-trust”." }, { "title": "VirtualBox", "url": "/posts/vbox/", "categories": "Virtualiztion, Network", "tags": "vbox, bash, shrink", "date": "2022-04-28 15:42:30 -0700", "snippet": "VPN virtualbox guest os through vpn Show route table on Windows: route print Shrink vbox harddisk Using zerofree to reduce Ubuntu/Debian OVA file size Start the machine in g...", "content": "VPN virtualbox guest os through vpn Show route table on Windows: route print Shrink vbox harddisk Using zerofree to reduce Ubuntu/Debian OVA file size Start the machine in graphical mode (Normal Start.) We want to interrupt the GRUB menu. Hold “shift key” How to get the GRUB using virtualbox? Press ‘e’ to edit the command list. Scroll down to the one that says “linux …”; it should be the next-to-last line. Move to the end of the line, and add break=init to the parameter list (separated by a space from the other parameters.) Press Ctrl+X or F10 to boot. Wait for the shell prompt. Run the commands: mount --bind /proc $rootmnt/procchroot $rootmnt /usr/sbin/zerofree -v [DEVICE]chroot $rootmnt /usr/sbin/zerofree -v /dev/sda5chroot $rootmnt /usr/sbin/zerofree -v /dev/mapper/ubuntu--vg-ubuntu--lv How to Shrink a VirtualBox Virtual Machine and Free Up Disk Space VBoxManage modifymedium disk disk.vdi --compact Old notes on shrinking vbox harddisk Install zerofree program: sudo apt-get install zerofree Reboot Ubuntu Ennter grub menu, and select advanced mode Then select “recovery mode”. Select “root” from Recovery Menu.Root shell Check to see disk names using “df” From the device list, find the dev name, in my case it is /dev/dm-0. Mount this disk as read only: “mount -o remount,ro /dev/dm-0 /” Make zeros: “zerofree /dev/dm-0”Shutdown UbuntuFrom the host executeVBoxManage modifyhd vdi_file.vdi --compactA note for Windows guestUse “sdelete -z” to zero out non-used spaces before modify the hard drive. Preferably, this is done before cleaning and fragmenting the disk.guest loses network after a few minutes How to restart network on Ubuntu 20.04 LTS Focal Fossasudo netplan apply" } ]
